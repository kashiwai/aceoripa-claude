(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5808],{2677:(e,t,a)=>{Promise.resolve().then(a.bind(a,4493))},4493:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>d});var s=a(5155),r=a(2115),n=a(1720),i=a(3568);let l=r.forwardRef(function(e,t){let{title:a,titleId:s,...n}=e;return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":s},n),a?r.createElement("title",{id:s},a):null,r.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M16.5 18.75h-9m9 0a3 3 0 0 1 3 3h-15a3 3 0 0 1 3-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 0 1-.982-3.172M9.497 14.25a7.454 7.454 0 0 0 .981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 0 0 7.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M7.73 9.728a6.726 6.726 0 0 0 2.748 1.35m8.272-6.842V4.5c0 2.108-.966 3.99-2.48 5.228m2.48-5.492a46.32 46.32 0 0 1 2.916.52 6.003 6.003 0 0 1-5.395 4.972m0 0a6.726 6.726 0 0 1-2.749 1.35m0 0a6.772 6.772 0 0 1-3.044 0"}))}),c=r.forwardRef(function(e,t){let{title:a,titleId:s,...n}=e;return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":s},n),a?r.createElement("title",{id:s},a):null,r.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z"}))});function d(){let e=(0,n.kT)("http://127.0.0.1:54321","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0"),[t,a]=(0,r.useState)([]),[d,o]=(0,r.useState)([]),[u,x]=(0,r.useState)(!0),[g,m]=(0,r.useState)("rankings"),[h,p]=(0,r.useState)("points"),[y,b]=(0,r.useState)("all_time"),[f,j]=(0,r.useState)(!1),[v,_]=(0,r.useState)(null),[w,N]=(0,r.useState)({ranking_type:"points",period:"all_time",reset_day:1,is_active:!0,display_count:10});(0,r.useEffect)(()=>{k(),S()},[h,y]);let k=async()=>{try{x(!0);let t="\n        SELECT \n          u.id,\n          u.email,\n          u.username,\n          COALESCE(SUM(pt.amount), 0) as total_points,\n          COUNT(DISTINCT uc.id) as card_count,\n          COUNT(DISTINCT g.id) as gacha_count,\n          MAX(g.created_at) as last_gacha_date\n        FROM auth.users u\n        LEFT JOIN point_transactions pt ON u.id = pt.user_id\n        LEFT JOIN user_cards uc ON u.id = uc.user_id\n        LEFT JOIN gacha_results g ON u.id = g.user_id\n      ";if("all_time"!==y){let e=O();t+=" WHERE (pt.created_at >= '".concat(e,"' OR pt.created_at IS NULL)\n                   AND (uc.created_at >= '").concat(e,"' OR uc.created_at IS NULL)\n                   AND (g.created_at >= '").concat(e,"' OR g.created_at IS NULL)")}switch(t+=" GROUP BY u.id, u.email, u.username",h){case"points":t+=" ORDER BY total_points DESC";break;case"cards":t+=" ORDER BY card_count DESC";break;case"gacha_count":t+=" ORDER BY gacha_count DESC"}t+=" LIMIT 100";let{data:s,error:r}=await e.rpc("get_user_rankings",{ranking_type:h,period:y});if(r){let{data:t,error:s}=await e.from("users").select("\n            *,\n            point_transactions(amount),\n            user_cards(id),\n            gacha_results(id, created_at)\n          ").limit(50);if(s)throw s;let r=(null==t?void 0:t.map(e=>{var t,a,s,r,n;return{id:e.id,email:e.email,username:e.username||"名前なし",total_points:(null==(t=e.point_transactions)?void 0:t.reduce((e,t)=>e+(t.amount||0),0))||0,card_count:(null==(a=e.user_cards)?void 0:a.length)||0,gacha_count:(null==(s=e.gacha_results)?void 0:s.length)||0,last_gacha_date:(null==(n=e.gacha_results)||null==(r=n[0])?void 0:r.created_at)||null,rank:0}}))||[];r.sort((e,t)=>{switch(h){case"points":return t.total_points-e.total_points;case"cards":return t.card_count-e.card_count;case"gacha_count":return t.gacha_count-e.gacha_count;default:return 0}}),r.forEach((e,t)=>{e.rank=t+1}),a(r)}else a(s||[])}catch(e){console.error("Error fetching rankings:",e),i.oR.error("ランキングの取得に失敗しました"),a([])}finally{x(!1)}},S=async()=>{try{let{data:t,error:a}=await e.from("ranking_settings").select("*").order("created_at",{ascending:!1});if(a)throw a;o(t||[])}catch(e){console.error("Error fetching settings:",e)}},O=()=>{let e=new Date;switch(y){case"daily":return new Date(e.setHours(0,0,0,0)).toISOString();case"weekly":return new Date(e.setDate(e.getDate()-e.getDay())).toISOString();case"monthly":return new Date(e.getFullYear(),e.getMonth(),1).toISOString();default:return"1970-01-01T00:00:00.000Z"}},E=async t=>{t.preventDefault(),x(!0);try{if(v){let{error:t}=await e.from("ranking_settings").update({...w,updated_at:new Date().toISOString()}).eq("id",v.id);if(t)throw t;i.oR.success("設定を更新しました")}else{let{error:t}=await e.from("ranking_settings").insert([{...w,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]);if(t)throw t;i.oR.success("設定を作成しました")}j(!1),_(null),C(),S()}catch(e){console.error("Error saving settings:",e),i.oR.error("設定の保存に失敗しました")}finally{x(!1)}},C=()=>{N({ranking_type:"points",period:"all_time",reset_day:1,is_active:!0,display_count:10})},I=async()=>{if(confirm("ランキングをリセットしますか？この操作は取り消せません。"))try{i.oR.success("ランキングをリセットしました"),k()}catch(e){console.error("Error resetting rankings:",e),i.oR.error("リセットに失敗しました")}},D=e=>{switch(h){case"points":return e.total_points.toLocaleString();case"cards":return e.card_count.toString();case"gacha_count":return e.gacha_count.toString();default:return"0"}},R=()=>{switch(h){case"points":return"pt";case"cards":return"枚";case"gacha_count":return"回";default:return""}};return(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"ランキング管理"}),(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsx)("button",{onClick:()=>m("rankings"),className:"px-4 py-2 rounded-md ".concat("rankings"===g?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"),children:"ランキング表示"}),(0,s.jsx)("button",{onClick:()=>m("settings"),className:"px-4 py-2 rounded-md ".concat("settings"===g?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"),children:"設定管理"})]})]}),"rankings"===g&&(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"bg-white p-4 rounded-lg shadow flex flex-wrap gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"ランキング種類"}),(0,s.jsxs)("select",{value:h,onChange:e=>p(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[(0,s.jsx)("option",{value:"points",children:"ポイント"}),(0,s.jsx)("option",{value:"cards",children:"カード所持数"}),(0,s.jsx)("option",{value:"gacha_count",children:"ガチャ回数"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"期間"}),(0,s.jsxs)("select",{value:y,onChange:e=>b(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[(0,s.jsx)("option",{value:"all_time",children:"全期間"}),(0,s.jsx)("option",{value:"monthly",children:"月間"}),(0,s.jsx)("option",{value:"weekly",children:"週間"}),(0,s.jsx)("option",{value:"daily",children:"日間"})]})]}),(0,s.jsx)("div",{className:"flex items-end",children:(0,s.jsx)("button",{onClick:I,className:"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700",children:"リセット"})})]}),(0,s.jsx)("div",{className:"bg-white shadow rounded-lg",children:(0,s.jsx)("div",{className:"px-4 py-5 sm:p-6",children:u?(0,s.jsx)("div",{className:"text-center py-4",children:"読み込み中..."}):0===t.length?(0,s.jsx)("div",{className:"text-center py-8 text-gray-500",children:"ランキングデータがありません"}):(0,s.jsx)("div",{className:"space-y-4",children:t.slice(0,10).map((e,t)=>(0,s.jsxs)("div",{className:"flex items-center justify-between p-4 rounded-lg border ".concat(0===t?"bg-yellow-50 border-yellow-200":1===t?"bg-gray-50 border-gray-200":2===t?"bg-orange-50 border-orange-200":"bg-white border-gray-200"),children:[(0,s.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,s.jsx)("div",{className:"flex items-center justify-center w-10 h-10 rounded-full ".concat(0===t?"bg-yellow-500 text-white":1===t?"bg-gray-500 text-white":2===t?"bg-orange-500 text-white":"bg-blue-500 text-white"),children:0===t?(0,s.jsx)(l,{className:"h-6 w-6"}):t+1}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsx)(c,{className:"h-4 w-4 text-gray-400"}),(0,s.jsx)("span",{className:"font-medium text-gray-900",children:e.username||e.email.split("@")[0]})]}),(0,s.jsx)("div",{className:"text-sm text-gray-500",children:e.email})]})]}),(0,s.jsxs)("div",{className:"text-right",children:[(0,s.jsxs)("div",{className:"text-lg font-bold text-gray-900",children:[D(e)," ",R()]}),(0,s.jsxs)("div",{className:"text-sm text-gray-500",children:["カード: ",e.card_count,"枚 | ガチャ: ",e.gacha_count,"回"]})]})]},e.id))})})})]}),"settings"===g&&(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)("div",{className:"flex justify-end",children:(0,s.jsx)("button",{onClick:()=>j(!0),className:"bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700",children:"新規設定作成"})}),(0,s.jsx)("div",{className:"bg-white shadow rounded-lg",children:(0,s.jsx)("div",{className:"px-4 py-5 sm:p-6",children:0===d.length?(0,s.jsx)("div",{className:"text-center py-8 text-gray-500",children:"設定がまだありません"}):(0,s.jsx)("div",{className:"overflow-x-auto",children:(0,s.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[(0,s.jsx)("thead",{className:"bg-gray-50",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"種類"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"期間"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"表示件数"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ステータス"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"作成日"})]})}),(0,s.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:d.map(e=>(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:"points"===e.ranking_type?"ポイント":"cards"===e.ranking_type?"カード数":"ガチャ回数"}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:"all_time"===e.period?"全期間":"monthly"===e.period?"月間":"weekly"===e.period?"週間":"日間"}),(0,s.jsxs)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:[e.display_count,"件"]}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,s.jsx)("span",{className:"inline-flex px-2 py-1 text-xs font-semibold rounded-full ".concat(e.is_active?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:e.is_active?"有効":"無効"})}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:new Date(e.created_at).toLocaleDateString("ja-JP")})]},e.id))})]})})})})]}),f&&(0,s.jsx)("div",{className:"fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50",children:(0,s.jsxs)("div",{className:"bg-white rounded-lg p-6 w-full max-w-md",children:[(0,s.jsx)("h2",{className:"text-lg font-medium text-gray-900 mb-4",children:"ランキング設定"}),(0,s.jsxs)("form",{onSubmit:E,className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"ランキング種類"}),(0,s.jsxs)("select",{value:w.ranking_type,onChange:e=>N({...w,ranking_type:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[(0,s.jsx)("option",{value:"points",children:"ポイント"}),(0,s.jsx)("option",{value:"cards",children:"カード所持数"}),(0,s.jsx)("option",{value:"gacha_count",children:"ガチャ回数"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"期間"}),(0,s.jsxs)("select",{value:w.period,onChange:e=>N({...w,period:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[(0,s.jsx)("option",{value:"all_time",children:"全期間"}),(0,s.jsx)("option",{value:"monthly",children:"月間"}),(0,s.jsx)("option",{value:"weekly",children:"週間"}),(0,s.jsx)("option",{value:"daily",children:"日間"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"表示件数"}),(0,s.jsx)("input",{type:"number",min:"1",max:"100",value:w.display_count,onChange:e=>N({...w,display_count:parseInt(e.target.value)}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("input",{type:"checkbox",id:"is_active",checked:w.is_active,onChange:e=>N({...w,is_active:e.target.checked}),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),(0,s.jsx)("label",{htmlFor:"is_active",className:"ml-2 block text-sm text-gray-900",children:"有効にする"})]}),(0,s.jsxs)("div",{className:"flex justify-end space-x-3 pt-4",children:[(0,s.jsx)("button",{type:"button",onClick:()=>{j(!1),_(null),C()},className:"px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300",children:"キャンセル"}),(0,s.jsx)("button",{type:"submit",disabled:u,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50",children:u?"保存中...":"保存"})]})]})]})})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[3568,4982,1720,8441,1684,7358],()=>t(2677)),_N_E=e.O()}]);
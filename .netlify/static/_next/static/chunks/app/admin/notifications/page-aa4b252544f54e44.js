(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[993],{4848:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>d});var a=s(5155),r=s(2115),i=s(1720),l=s(3568);let n=r.forwardRef(function(e,t){let{title:s,titleId:a,...i}=e;return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":a},i),s?r.createElement("title",{id:a},s):null,r.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0"}))});var c=s(6865);function d(){let e=(0,i.kT)("http://127.0.0.1:54321","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0"),[t,s]=(0,r.useState)([]),[d,o]=(0,r.useState)(null),[u,x]=(0,r.useState)(!0),[m,g]=(0,r.useState)("notifications"),[p,h]=(0,r.useState)(!1),[f,y]=(0,r.useState)(null),[b,v]=(0,r.useState)({title:"",body:"",target_type:"all",target_users:[],target_segment:"",scheduled_at:""}),[j,w]=(0,r.useState)({vapid_public_key:"",vapid_private_key:"",default_icon:"/icon-192x192.png",default_badge:"/badge-72x72.png",is_enabled:!0}),[_,N]=(0,r.useState)([]);(0,r.useEffect)(()=>{k(),C(),S()},[]);let k=async()=>{try{let{data:t,error:a}=await e.from("push_notifications").select("*").order("created_at",{ascending:!1});if(a)throw a;s(t||[])}catch(e){console.error("Error fetching notifications:",e),l.oR.error("通知の取得に失敗しました")}finally{x(!1)}},C=async()=>{try{let{data:s,error:a}=await e.from("notification_settings").select("*").single();if(a&&"PGRST116"!==a.code)throw a;if(s){var t;o(s),w({vapid_public_key:s.vapid_public_key||"",vapid_private_key:s.vapid_private_key||"",default_icon:s.default_icon||"/icon-192x192.png",default_badge:s.default_badge||"/badge-72x72.png",is_enabled:null==(t=s.is_enabled)||t})}}catch(e){console.error("Error fetching settings:",e)}},S=async()=>{try{let{data:t,error:s}=await e.from("users").select("id, email, username").limit(100);if(s)throw s;N(t||[])}catch(e){console.error("Error fetching users:",e)}},I=async t=>{t.preventDefault(),x(!0);try{let t={...b,status:b.scheduled_at?"scheduled":"draft",click_count:0,delivery_count:0,updated_at:new Date().toISOString()};if(f){let{error:s}=await e.from("push_notifications").update(t).eq("id",f.id);if(s)throw s;l.oR.success("通知を更新しました")}else{let{error:s}=await e.from("push_notifications").insert([{...t,created_at:new Date().toISOString()}]);if(s)throw s;l.oR.success("通知を作成しました")}h(!1),y(null),D(),k()}catch(e){console.error("Error saving notification:",e),l.oR.error("保存に失敗しました")}finally{x(!1)}},E=async t=>{t.preventDefault(),x(!0);try{let t={...j,updated_at:new Date().toISOString()};if(d){let{error:s}=await e.from("notification_settings").update(t).eq("id",d.id);if(s)throw s;l.oR.success("設定を更新しました")}else{let{error:s}=await e.from("notification_settings").insert([{...t,created_at:new Date().toISOString()}]);if(s)throw s;l.oR.success("設定を作成しました")}C()}catch(e){console.error("Error saving settings:",e),l.oR.error("設定の保存に失敗しました")}finally{x(!1)}},R=async t=>{if(confirm("この通知を送信しますか？"))try{x(!0);let s=await fetch("/api/admin/notifications/send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t.id,title:t.title,body:t.body,target_type:t.target_type,target_users:t.target_users,target_segment:t.target_segment})});if(!s.ok)throw Error("送信に失敗しました");let a=await s.json(),{error:r}=await e.from("push_notifications").update({status:"sent",sent_at:new Date().toISOString(),delivery_count:a.delivery_count||0}).eq("id",t.id);if(r)throw r;l.oR.success("通知を送信しました (".concat(a.delivery_count||0,"件配信)")),k()}catch(e){console.error("Error sending notification:",e),l.oR.error("送信に失敗しました")}finally{x(!1)}},O=async()=>{try{if(!("serviceWorker"in navigator)||!("PushManager"in window))return void l.oR.error("このブラウザはプッシュ通知をサポートしていません");let e=await Notification.requestPermission();if("granted"!==e)return void l.oR.error("通知の許可が必要です");new Notification("ACEorIPA テスト通知",{body:"プッシュ通知の設定が正常です",icon:"/icon-192x192.png",badge:"/badge-72x72.png"}),l.oR.success("テスト通知を送信しました")}catch(e){console.error("Error testing notification:",e),l.oR.error("テスト通知の送信に失敗しました")}},D=()=>{v({title:"",body:"",target_type:"all",target_users:[],target_segment:"",scheduled_at:""})},A=e=>{y(e),v({title:e.title,body:e.body,target_type:e.target_type,target_users:e.target_users||[],target_segment:e.target_segment||"",scheduled_at:e.scheduled_at?e.scheduled_at.split("T")[0]:""}),h(!0)},P=e=>({draft:"下書き",scheduled:"予約中",sent:"送信済み",failed:"失敗"})[e]||e,J=e=>({all:"全ユーザー",specific:"指定ユーザー",segment:"セグメント"})[e]||e;return(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"プッシュ通知管理"}),(0,a.jsxs)("div",{className:"flex space-x-2",children:[(0,a.jsx)("button",{onClick:()=>g("notifications"),className:"px-4 py-2 rounded-md ".concat("notifications"===m?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"),children:"通知管理"}),(0,a.jsx)("button",{onClick:()=>g("settings"),className:"px-4 py-2 rounded-md ".concat("settings"===m?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"),children:"設定"})]})]}),"notifications"===m&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("div",{className:"flex justify-between items-center",children:(0,a.jsxs)("div",{className:"flex space-x-2",children:[(0,a.jsxs)("button",{onClick:()=>h(!0),className:"bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center gap-2",children:[(0,a.jsx)(n,{className:"h-5 w-5"}),"新規作成"]}),(0,a.jsxs)("button",{onClick:O,className:"bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center gap-2",children:[(0,a.jsx)(c.A,{className:"h-5 w-5"}),"テスト通知"]})]})}),(0,a.jsx)("div",{className:"bg-white shadow rounded-lg",children:(0,a.jsx)("div",{className:"px-4 py-5 sm:p-6",children:u?(0,a.jsx)("div",{className:"text-center py-4",children:"読み込み中..."}):0===t.length?(0,a.jsx)("div",{className:"text-center py-8 text-gray-500",children:"通知がまだありません"}):(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[(0,a.jsx)("thead",{className:"bg-gray-50",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"タイトル"}),(0,a.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"対象"}),(0,a.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ステータス"}),(0,a.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"配信数"}),(0,a.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"クリック数"}),(0,a.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"作成日"}),(0,a.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"操作"})]})}),(0,a.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:t.map(e=>(0,a.jsxs)("tr",{children:[(0,a.jsxs)("td",{className:"px-6 py-4 whitespace-nowrap",children:[(0,a.jsx)("div",{className:"text-sm font-medium text-gray-900",children:e.title}),(0,a.jsxs)("div",{className:"text-sm text-gray-500",children:[e.body.substring(0,50),"..."]})]}),(0,a.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:J(e.target_type)}),(0,a.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,a.jsx)("span",{className:"inline-flex px-2 py-1 text-xs font-semibold rounded-full ".concat("sent"===e.status?"bg-green-100 text-green-800":"scheduled"===e.status?"bg-blue-100 text-blue-800":"failed"===e.status?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"),children:P(e.status)})}),(0,a.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:e.delivery_count}),(0,a.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:e.click_count}),(0,a.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:new Date(e.created_at).toLocaleDateString("ja-JP")}),(0,a.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:(0,a.jsxs)("div",{className:"flex space-x-2",children:[(0,a.jsx)("button",{onClick:()=>A(e),className:"text-indigo-600 hover:text-indigo-900",children:"編集"}),"draft"===e.status&&(0,a.jsx)("button",{onClick:()=>R(e),className:"text-green-600 hover:text-green-900",children:"送信"})]})})]},e.id))})]})})})})]}),"settings"===m&&(0,a.jsx)("div",{className:"bg-white shadow rounded-lg",children:(0,a.jsxs)("div",{className:"px-4 py-5 sm:p-6",children:[(0,a.jsx)("h2",{className:"text-lg font-medium text-gray-900 mb-4",children:"プッシュ通知設定"}),(0,a.jsxs)("form",{onSubmit:E,className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"VAPID公開キー"}),(0,a.jsx)("input",{type:"text",value:j.vapid_public_key,onChange:e=>w({...j,vapid_public_key:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"VAPID公開キーを入力"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"VAPID秘密キー"}),(0,a.jsx)("input",{type:"password",value:j.vapid_private_key,onChange:e=>w({...j,vapid_private_key:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"VAPID秘密キーを入力"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"デフォルトアイコン"}),(0,a.jsx)("input",{type:"text",value:j.default_icon,onChange:e=>w({...j,default_icon:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"/icon-192x192.png"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"デフォルトバッジ"}),(0,a.jsx)("input",{type:"text",value:j.default_badge,onChange:e=>w({...j,default_badge:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"/badge-72x72.png"})]}),(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("input",{type:"checkbox",id:"is_enabled",checked:j.is_enabled,onChange:e=>w({...j,is_enabled:e.target.checked}),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),(0,a.jsx)("label",{htmlFor:"is_enabled",className:"ml-2 block text-sm text-gray-900",children:"プッシュ通知を有効にする"})]}),(0,a.jsx)("div",{className:"pt-4",children:(0,a.jsx)("button",{type:"submit",disabled:u,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50",children:u?"保存中...":"設定を保存"})})]})]})}),p&&(0,a.jsx)("div",{className:"fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto",children:[(0,a.jsx)("h2",{className:"text-lg font-medium text-gray-900 mb-4",children:f?"通知編集":"通知作成"}),(0,a.jsxs)("form",{onSubmit:I,className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"タイトル"}),(0,a.jsx)("input",{type:"text",value:b.title,onChange:e=>v({...b,title:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"メッセージ"}),(0,a.jsx)("textarea",{value:b.body,onChange:e=>v({...b,body:e.target.value}),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"送信対象"}),(0,a.jsxs)("select",{value:b.target_type,onChange:e=>v({...b,target_type:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[(0,a.jsx)("option",{value:"all",children:"全ユーザー"}),(0,a.jsx)("option",{value:"specific",children:"指定ユーザー"}),(0,a.jsx)("option",{value:"segment",children:"セグメント"})]})]}),"specific"===b.target_type&&(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"対象ユーザー"}),(0,a.jsx)("select",{multiple:!0,value:b.target_users,onChange:e=>v({...b,target_users:Array.from(e.target.selectedOptions,e=>e.value)}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",size:5,children:_.map(e=>(0,a.jsx)("option",{value:e.id,children:e.username||e.email},e.id))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"送信予約日時（任意）"}),(0,a.jsx)("input",{type:"datetime-local",value:b.scheduled_at,onChange:e=>v({...b,scheduled_at:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,a.jsxs)("div",{className:"flex justify-end space-x-3 pt-4",children:[(0,a.jsx)("button",{type:"button",onClick:()=>{h(!1),y(null),D()},className:"px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300",children:"キャンセル"}),(0,a.jsx)("button",{type:"submit",disabled:u,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50",children:u?"保存中...":"保存"})]})]})]})})]})}},6865:(e,t,s)=>{"use strict";s.d(t,{A:()=>r});var a=s(2115);let r=a.forwardRef(function(e,t){let{title:s,titleId:r,...i}=e;return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":r},i),s?a.createElement("title",{id:r},s):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"}))})},7660:(e,t,s)=>{Promise.resolve().then(s.bind(s,4848))}},e=>{var t=t=>e(e.s=t);e.O(0,[3568,4982,1720,8441,1684,7358],()=>t(7660)),_N_E=e.O()}]);